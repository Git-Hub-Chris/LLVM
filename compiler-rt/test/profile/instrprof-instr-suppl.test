// This is a regression test for supplementary profiles.

// What the test does:
// - Generate raw profiles from an executable and convert it to indexed profiles.
// - Merge indexed profiles with supplementary sample-pgo profiles
// - Check that the block counters for function foo is scaled up.

// REQUIRES: linux
// REQUIRES: lld-available

// The test failed on ppc when building the instrumented binary.
// ld.lld: error: /lib/../lib64/Scrt1.o: ABI version 1 is not supported
// UNSUPPORTED: ppc

// This compiler-rt test and test llvm/test/tools/llvm-profdata/suppl-instr-with-sample-static-func.test are
// complementary to each other.

// RUN: rm -rf %t && split-file %s %t && cd %t

// Use clangxx_pgogen for IR level instrumentation for C++.
// The test case is constructed such that `-funique-internal-linkage-names` is
// not used in instrPGO but used in static function names in SamplePGO.
// RUN: %clangxx_pgogen -fuse-ld=lld -O2 main.cpp -o main
// RUN: env LLVM_PROFILE_FILE=main.profraw %run ./main
// RUN: llvm-profdata merge main.profraw -o main.profdata

// The function counters are not scaled up.
// RUN: llvm-profdata show -all-functions -counts main.profdata | FileCheck %s --check-prefix=INSTR

// The function counter for static function foo should be scaled up.
// RUN: llvm-profdata merge -supplement-instr-with-sample=sampleprof.proftext -suppl-min-size-threshold=0 -instr-prof-cold-threshold=1 main.profdata -o merge.profdata
// RUN: llvm-profdata show -all-functions -counts merge.profdata | FileCheck %s --check-prefix=SUPPL

// INSTR: Counters:
// INSTR:   main:
// INSTR:     Counters: 1
// INSTR:     Block counts: [1]
// INSTR:   _Z3barv:
// INSTR:     Counters: 1
// INSTR:     Block counts: [2]
// INSTR:   main.cpp;_ZL3foov:
// INSTR:     Counters: 1
// INSTR:     Block counts: [1]

// INSTR: Functions shown: 3
// INSTR: Total functions: 3

// SUPPL: Counters:
// SUPPL:   main:
// SUPPL:     Counters: 1
// SUPPL:     Block counts: [1]
// SUPPL:   _Z3barv:
// SUPPL:     Counters: 1
// SUPPL:     Block counts: [2]
// SUPPL:   main.cpp;_ZL3foov:
// SUPPL:     Counters: 1
// SUPPL:     Block counts: [3]

//--- main.cpp

// mark foo and bar as noinline so preinliner won't inlined them into main
// before the instrumentation pass.
__attribute__((noinline)) static void foo() {
}

__attribute__((noinline)) void bar() {
}

int main() {
  foo();
  bar();
  bar();
  return 0;
}

//--- sampleprof.proftext
// Function name is uniqufied by `-funique-internal-linkage-names`.
_ZL3foov.__uniq.23343505234642233139497840575431302970:5:5
  1: 5

