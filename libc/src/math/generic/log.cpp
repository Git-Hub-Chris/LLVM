//===-- Double-precision log(x) function ----------------------------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//

#include "src/math/log.h"
#include "src/__support/FPUtil/FEnvImpl.h"
#include "src/__support/FPUtil/FPBits.h"
#include "src/__support/FPUtil/PolyEval.h"
#include "src/__support/FPUtil/double_double.h"
#include "src/__support/FPUtil/dyadic_float.h"
#include "src/__support/FPUtil/multiply_add.h"
#include "src/__support/common.h"
#include "src/__support/integer_literals.h"
#include "src/__support/macros/optimization.h" // LIBC_UNLIKELY

#include "common_constants.h"
#include "log_range_reduction.h"

namespace LIBC_NAMESPACE {

// 128-bit precision dyadic floating point numbers.
using Float128 = typename fputil::DyadicFloat<128>;
using Sign = fputil::Sign;
using LIBC_NAMESPACE::operator""_u128;

namespace {

// A simple upper bound for the error of e_x * log(2) - log(r).
constexpr double HI_ERR = 0x1.0p-85;

// Extra errors from P is from using x^2 to reduce evaluation latency.
constexpr double P_ERR = 0x1.0p-50;

// log(2) with 128-bit prepcision generated by SageMath with:
//   sage: (s, m, e) = RealField(128)(2).log().sign_mantissa_exponent();
//   sage: print(hex(m), "_u128");
const Float128 LOG_2(Sign::POS, /*exponent=*/-128, /*mantissa=*/
                     0xb17217f7d1cf79abc9e3b39803f2f6af_u128);

alignas(64) const LogRR LOG_TABLE = {
    // -log(r) with 128-bit precision generated by SageMath with:
    //
    // for i in range(128):
    //   r = 2^-8 * ceil( 2^8 * (1 - 2^(-8)) / (1 + i*2^(-7)) );
    //   s, m, e = RealField(128)(r).log().sign_mantissa_exponent();
    //   print("{Sign::POS,", e, ", hex(m), "_u128},");
    /* .step_1= */ {
        {Sign::POS, 0, 0_u128},
        {Sign::POS, -134, 0x8080abac46f38946662d417ced007a46_u128},
        {Sign::POS, -133, 0x8102b2c49ac23a4f91d082dce3ddcd38_u128},
        {Sign::POS, -133, 0xc24929464655f45cda5f3cc0b3251dbd_u128},
        {Sign::POS, -132, 0x820aec4f3a222380b9e3aea6c444ef07_u128},
        {Sign::POS, -132, 0xa33576a16f1f4c64521016bd904dc968_u128},
        {Sign::POS, -132, 0xc4a550a4fd9a19a8be97660a23cc540d_u128},
        {Sign::POS, -132, 0xe65b9e6eed965c36e09f5fe2058d6006_u128},
        {Sign::POS, -131, 0x842cc5acf1d034451fecdfa819b96098_u128},
        {Sign::POS, -131, 0x8cb9de8a32ab368aa7c9859530a45153_u128},
        {Sign::POS, -131, 0x9defad3e8f73217a976d3b5b45f6ca0b_u128},
        {Sign::POS, -131, 0xaf4ad26cbc8e5be70e8b8b88a14ff0ce_u128},
        {Sign::POS, -131, 0xb8069857560707a36a677b4c8bec22e1_u128},
        {Sign::POS, -131, 0xc99af2eaca4c4570eaf51f66692844ba_u128},
        {Sign::POS, -131, 0xdb56446d6ad8deffa8112e35a60e6375_u128},
        {Sign::POS, -131, 0xe442c00de2591b47196ab34ce0bccd12_u128},
        {Sign::POS, -131, 0xf639cc185088fe5d4066e87f2c0f7340_u128},
        {Sign::POS, -131, 0xff4489cedeab2ca6c17bd40d8d9291ec_u128},
        {Sign::POS, -130, 0x88bc74113f23def19c5a0fe396f40f1e_u128},
        {Sign::POS, -130, 0x8d515bf11fb94f1c88713268840cbcc0_u128},
        {Sign::POS, -130, 0x968b08643409ceb665c0da506a088484_u128},
        {Sign::POS, -130, 0x9b2fe580ac80b17d411a5b944aca8708_u128},
        {Sign::POS, -130, 0xa489ec199dab06f2a9fb6cf0ecb411b7_u128},
        {Sign::POS, -130, 0xa93f2f250dac67d1cad2fb8d48054ae0_u128},
        {Sign::POS, -130, 0xb2ba75f46099cf8b2c3c2e77904afa78_u128},
        {Sign::POS, -130, 0xb780945bab55dce434c7bc3d32750fde_u128},
        {Sign::POS, -130, 0xc11e0b2a8d1e0ddb9a631e830fd30904_u128},
        {Sign::POS, -130, 0xc5f57f59c7f46155aa8b6997a402bf30_u128},
        {Sign::POS, -130, 0xcad2d6e7b80bf9142c507fb7a3d0bf6a_u128},
        {Sign::POS, -130, 0xd49f69e456cf1b795f53bd2e406e66e7_u128},
        {Sign::POS, -130, 0xd98ec2bade71e53958a98f2ad65bee9b_u128},
        {Sign::POS, -130, 0xde8439c1dec568774d57da945b5d0aaa_u128},
        {Sign::POS, -130, 0xe881bf932af3dac0c524848e3443e040_u128},
        {Sign::POS, -130, 0xed89ed86a44a01aa11d49f96cb88317b_u128},
        {Sign::POS, -130, 0xf29877ff388090913b020fa1820c9492_u128},
        {Sign::POS, -130, 0xf7ad6f26e7ff2ef754d2238f75f969b1_u128},
        {Sign::POS, -130, 0xfcc8e3659d9bcbecca0cdf301431b60f_u128},
        {Sign::POS, -129, 0x8389c3026ac3139b62dda9d2270fa1f4_u128},
        {Sign::POS, -129, 0x86216b3b0b17188b163ceae88f720f1e_u128},
        {Sign::POS, -129, 0x88bc74113f23def19c5a0fe396f40f1e_u128},
        {Sign::POS, -129, 0x8b5ae65d67db9acdf7a5168126a58b9a_u128},
        {Sign::POS, -129, 0x8dfccb1ad35ca6ed5147bdb6ddcaf59c_u128},
        {Sign::POS, -129, 0x934b1089a6dc93c1df5bb3b60554e152_u128},
        {Sign::POS, -129, 0x95f783e6e49a9cfa4a5004f3ef063313_u128},
        {Sign::POS, -129, 0x98a78f0e9ae71d852cdec34784707839_u128},
        {Sign::POS, -129, 0x9b5b3bb5f088b766d878bbe3d392be25_u128},
        {Sign::POS, -129, 0x9e1293b9998c1daa5b035eae273a855f_u128},
        {Sign::POS, -129, 0xa0cda11eaf46390dbb2438273918db7e_u128},
        {Sign::POS, -129, 0xa38c6e138e20d831f698298adddd7f32_u128},
        {Sign::POS, -129, 0xa64f04f0b961df76e4f5275c2d15c21f_u128},
        {Sign::POS, -129, 0xa9157039c51ebe708164c759686a2209_u128},
        {Sign::POS, -129, 0xabdfba9e468fd6f6f72ea07749ce6bd3_u128},
        {Sign::POS, -129, 0xaeadeefacaf97d357dd6e688ebb13b03_u128},
        {Sign::POS, -129, 0xb1801859d56249dc18ce51fff99479cd_u128},
        {Sign::POS, -129, 0xb45641f4e350a0d32756eba00bc33978_u128},
        {Sign::POS, -129, 0xb730773578cb90b2be1116c3466beb6d_u128},
        {Sign::POS, -129, 0xba0ec3b633dd8b0949dc60b2b059a60b_u128},
        {Sign::POS, -129, 0xbcf13343e7d9ec7d2efd17781bb3afec_u128},
        {Sign::POS, -129, 0xbfd7d1dec0a8df6f37eda996244bccb0_u128},
        {Sign::POS, -129, 0xc2c2abbb6e5fd56f33337789d592e296_u128},
        {Sign::POS, -129, 0xc5b1cd44596fa51e1a18fb8f9f9ef280_u128},
        {Sign::POS, -129, 0xc8a5431adfb44ca5688ce7c1a75e341a_u128},
        {Sign::POS, -129, 0xcb9d1a189ab56e762d7e9307c70c0668_u128},
        {Sign::POS, -129, 0xce995f50af69d861ef2f3f4f861ad6a9_u128},
        {Sign::POS, -129, 0xd19a201127d3c6457f9d79f51dcc7301_u128},
        {Sign::POS, -129, 0xd19a201127d3c6457f9d79f51dcc7301_u128},
        {Sign::POS, -129, 0xd49f69e456cf1b795f53bd2e406e66e7_u128},
        {Sign::POS, -129, 0xd7a94a92466e833aad88bba7d0cee8e0_u128},
        {Sign::POS, -129, 0xdab7d02231484a9296c20cca6efe2ac5_u128},
        {Sign::POS, -129, 0xddcb08dc0717d85bf40a666c87842843_u128},
        {Sign::POS, -129, 0xe0e30349fd1cec807fe8e1802aba24d6_u128},
        {Sign::POS, -129, 0xe0e30349fd1cec807fe8e1802aba24d6_u128},
        {Sign::POS, -129, 0xe3ffce3a2aa649223eadb651b49ac53a_u128},
        {Sign::POS, -129, 0xe72178c0323a1a0f304e1653e71d9973_u128},
        {Sign::POS, -129, 0xea481236f7d35bafe9a767a80d6d97e8_u128},
        {Sign::POS, -129, 0xed73aa4264b0ade94f91cf4b33e42998_u128},
        {Sign::POS, -129, 0xf0a450d139366ca6fc66eb6408ff6433_u128},
        {Sign::POS, -129, 0xf0a450d139366ca6fc66eb6408ff6433_u128},
        {Sign::POS, -129, 0xf3da161eed6b9aafac8d42f78d3e65d3_u128},
        {Sign::POS, -129, 0xf7150ab5a09f27f45a470250d40ebe90_u128},
        {Sign::POS, -129, 0xfa553f7018c966f2b780a545a1b54dcf_u128},
        {Sign::POS, -129, 0xfa553f7018c966f2b780a545a1b54dcf_u128},
        {Sign::POS, -129, 0xfd9ac57bd244217e8f05924d258c14c5_u128},
        {Sign::POS, -128, 0x8072d72d903d588b89d1b09c70c4010a_u128},
        {Sign::POS, -128, 0x821b05f3b01d6774030d58c3f7e2ea1f_u128},
        {Sign::POS, -128, 0x821b05f3b01d6774030d58c3f7e2ea1f_u128},
        {Sign::POS, -128, 0x83c5f8299e2b409120f6fafe8fbb68b9_u128},
        {Sign::POS, -128, 0x8573b71682a7d21ae21f9f89c1ab80b2_u128},
        {Sign::POS, -128, 0x8573b71682a7d21ae21f9f89c1ab80b2_u128},
        {Sign::POS, -128, 0x87244c308e670a6601e005d06dbfa8f8_u128},
        {Sign::POS, -128, 0x88d7c11e3ad53cdc223111a707b6de2c_u128},
        {Sign::POS, -128, 0x88d7c11e3ad53cdc223111a707b6de2c_u128},
        {Sign::POS, -128, 0x8a8e1fb794b091342eb628dba173c82d_u128},
        {Sign::POS, -128, 0x8c47720791e53313be2ad19415fe25a5_u128},
        {Sign::POS, -128, 0x8c47720791e53313be2ad19415fe25a5_u128},
        {Sign::POS, -128, 0x8e03c24d73003959bddae1ccce247838_u128},
        {Sign::POS, -128, 0x8fc31afe30b2c6de9b00bf167e95da67_u128},
        {Sign::POS, -128, 0x8fc31afe30b2c6de9b00bf167e95da67_u128},
        {Sign::POS, -128, 0x918586c5f5e4bf019b92199ed1a4bab1_u128},
        {Sign::POS, -128, 0x934b1089a6dc93c1df5bb3b60554e152_u128},
        {Sign::POS, -128, 0x934b1089a6dc93c1df5bb3b60554e152_u128},
        {Sign::POS, -128, 0x9513c36876083695f3cbc416a2418012_u128},
        {Sign::POS, -128, 0x96dfaabd86fa1646be1188fbc94e2f15_u128},
        {Sign::POS, -128, 0x96dfaabd86fa1646be1188fbc94e2f15_u128},
        {Sign::POS, -128, 0x98aed221a03458b61d2f89321647b358_u128},
        {Sign::POS, -128, 0x98aed221a03458b61d2f89321647b358_u128},
        {Sign::POS, -128, 0x9a81456cec642e0fe549f9aaea3cb5e1_u128},
        {Sign::POS, -128, 0x9c5710b8cbb73a42a2554b2dd4619e63_u128},
        {Sign::POS, -128, 0x9c5710b8cbb73a42a2554b2dd4619e63_u128},
        {Sign::POS, -128, 0x9e304061b5fda91930603d87b6df81ad_u128},
        {Sign::POS, -128, 0x9e304061b5fda91930603d87b6df81ad_u128},
        {Sign::POS, -128, 0xa00ce1092e5498c367879c5a30cd1242_u128},
        {Sign::POS, -128, 0xa1ecff97c91e267b0b7efae08e597e16_u128},
        {Sign::POS, -128, 0xa1ecff97c91e267b0b7efae08e597e16_u128},
        {Sign::POS, -128, 0xa3d0a93f45169a4a83594fab088c0d65_u128},
        {Sign::POS, -128, 0xa3d0a93f45169a4a83594fab088c0d65_u128},
        {Sign::POS, -128, 0xa5b7eb7cb860fb88af6a62a0dec6e073_u128},
        {Sign::POS, -128, 0xa5b7eb7cb860fb88af6a62a0dec6e073_u128},
        {Sign::POS, -128, 0xa7a2d41ad270c9d749362382a768847a_u128},
        {Sign::POS, -128, 0xa7a2d41ad270c9d749362382a768847a_u128},
        {Sign::POS, -128, 0xa991713433c2b9988ba4aea614d05701_u128},
        {Sign::POS, -128, 0xa991713433c2b9988ba4aea614d05701_u128},
        {Sign::POS, -128, 0xab83d135dc6333017fe6607ba902ef3c_u128},
        {Sign::POS, -128, 0xab83d135dc6333017fe6607ba902ef3c_u128},
        {Sign::POS, -128, 0xad7a02e1b24efd31d60864fd949b4bd3_u128},
        {Sign::POS, -128, 0xad7a02e1b24efd31d60864fd949b4bd3_u128},
        {Sign::POS, -128, 0xaf74155120c9011c066d235ee63073dd_u128},
        {Sign::POS, 0, 0_u128},
    },
    // -log(r) for the second step, generated by SageMath with:
    //
    // for i in range(-2^6, 2^7 + 1):
    //   r = 2^-16 * round( 2^16 / (1 + i*2^(-14)) );
    //   s, m, e = RealField(128)(r).log().sign_mantissa_exponent();
    //   print("{Sign::POS," if s == -1 else "{Sign::NEG,", e, ",
    //         hex(m), "_u128},");
    /* .step_2 = */
    {
        {Sign::NEG, -135, 0x803faacac419abf2a1c6f3fc242ef8d0_u128},
        {Sign::NEG, -136, 0xfc834da16f0d9f57a225ebc02e6d9dd4_u128},
        {Sign::NEG, -136, 0xf88735ccc7433381c33f6ad340ae18a9_u128},
        {Sign::NEG, -136, 0xf48b0e171249b6bc70b2a4d38a242244_u128},
        {Sign::NEG, -136, 0xf08ed67fd190e2801d54819048b811b0_u128},
        {Sign::NEG, -136, 0xec928f0686828706aee5983701d2a02b_u128},
        {Sign::NEG, -136, 0xe89637aab2828aed40abb8ab72afa2d2_u128},
        {Sign::NEG, -136, 0xe499d06bd6eeead5deb547a0d4a26ef9_u128},
        {Sign::NEG, -136, 0xe09d5949751fb90939c5bdfbcf6087a0_u128},
        {Sign::NEG, -136, 0xdca0d2430e671d1853ea9bf152de635f_u128},
        {Sign::NEG, -136, 0xd8a43b582411537e25b820436f5f4352_u128},
        {Sign::NEG, -136, 0xd4a794883764ad413c2d13ea1d0be058_u128},
        {Sign::NEG, -136, 0xd0aaddd2c9a18f954f3cfa62bcb3ce3a_u128},
        {Sign::NEG, -136, 0xccae17375c02737cd0fff6cdf14a86c7_u128},
        {Sign::NEG, -136, 0xc8b140b56fbbe56a7587b5f0453ac3d2_u128},
        {Sign::NEG, -136, 0xc4b45a4c85fc84e2b358ad16dfd0d085_u128},
        {Sign::NEG, -136, 0xc0b763fc1fed041d3c86fdce5dbe7314_u128},
        {Sign::NEG, -136, 0xbcba5dc3beb027a670764e46ac18a96d_u128},
        {Sign::NEG, -136, 0xb8bd47a2e362c600c63be62b8f285882_u128},
        {Sign::NEG, -136, 0xb3c0d59a244325a472e7b5a386e5e31b_u128},
        {Sign::NEG, -136, 0xafc39bac66434f27c3ea2cd93f316b34_u128},
        {Sign::NEG, -136, 0xabc651d491a7b4381dfb11a7cc892843_u128},
        {Sign::NEG, -136, 0xa7c8f8122773f38dfc679a28e9d9f212_u128},
        {Sign::NEG, -136, 0xa3cb8e64a8a5bbe6e7bc977eeec42254_u128},
        {Sign::NEG, -136, 0x9fce14cb9634cba6b20f215bd3b58c61_u128},
        {Sign::NEG, -136, 0x9bd08b467112f078abe2862508d67a98_u128},
        {Sign::NEG, -136, 0x97d2f1d4ba2c06f0d1aacedcefe9d377_u128},
        {Sign::NEG, -136, 0x93d54875f265fa2cf1eb25e77d05f58d_u128},
        {Sign::NEG, -136, 0x8fd78f299aa0c375cbef6fac33691e95_u128},
        {Sign::NEG, -136, 0x8bd9c5ef33b669e02720640462a0f8ad_u128},
        {Sign::NEG, -136, 0x87dbecc63e7b01ede2f1775134c8da75_u128},
        {Sign::NEG, -136, 0x83de03ae3bbcad2eff67e201c8c50d67_u128},
        {Sign::NEG, -137, 0xffc0154d588733c53c742a7c76356396_u128},
        {Sign::NEG, -137, 0xf7c4035e21a4052ff90dd6b24aa686ec_u128},
        {Sign::NEG, -137, 0xefc7d18dd4485b9eca47c52b7d7ffce2_u128},
        {Sign::NEG, -137, 0xe7cb7fdb71e0db363703617ad3d8311f_u128},
        {Sign::NEG, -137, 0xdfcf0e45fbce3e807e4cfbd830393b88_u128},
        {Sign::NEG, -137, 0xd7d27ccc736555af4f7a29cf0fc2c38e_u128},
        {Sign::NEG, -137, 0xcfd5cb6dd9ef05dd7370ae83f9e72748_u128},
        {Sign::NEG, -137, 0xc7d8fa2930a84850671486eb4cd76f65_u128},
        {Sign::NEG, -137, 0xbfdc08fd78c229b9e6dbb624f9739782_u128},
        {Sign::NEG, -137, 0xb7def7e9b361c9796b866e09e57d9079_u128},
        {Sign::NEG, -137, 0xafe1c6ece1a058dd97fa2fd0c9dc723e_u128},
        {Sign::NEG, -137, 0xa7e47606048b1a65983e80897cf1e60f_u128},
        {Sign::NEG, -137, 0x9fe705341d2361027199cd06ae5d39b3_u128},
        {Sign::NEG, -137, 0x97e974762c5e8f5843cd18a72a051a96_u128},
        {Sign::NEG, -137, 0x8febc3cb332616ff7b6d1248c3e1fd40_u128},
        {Sign::NEG, -137, 0x87edf332325777c5f5572a8814c703af_u128},
        {Sign::NEG, -138, 0xffe0055455887de026828c92649a3a39_u128},
        {Sign::NEG, -138, 0xefe3e4643a640cf382c550bd1216d82a_u128},
        {Sign::NEG, -138, 0xdfe7839214b4e8aeda6959f7f0e01bf0_u128},
        {Sign::NEG, -138, 0xcfeae2dbe5d6736dda93e2fa85a8f214_u128},
        {Sign::NEG, -138, 0xbfee023faf0c2480b47505bfa5a03b06_u128},
        {Sign::NEG, -138, 0xaff0e1bb718186adb1475a5180a43520_u128},
        {Sign::NEG, -138, 0x9ff3814d2e4a36b2a8740b91c95df537_u128},
        {Sign::NEG, -138, 0x8ff5e0f2e661e1c657d895d35921b59c_u128},
        {Sign::NEG, -139, 0xfff00155355888333c56c598c659c2a3_u128},
        {Sign::NEG, -139, 0xdff3c0e497ea4eb12ef8ec33ed9d782a_u128},
        {Sign::NEG, -139, 0xbff7008ff5e0c257379eba7e6465ff63_u128},
        {Sign::NEG, -139, 0x9ff9c0535073a3703f972b783fcab757_u128},
        {Sign::NEG, -140, 0xfff8005551558885de026e271ee0549d_u128},
        {Sign::NEG, -140, 0xbffb8023febc0c25eceb47ea01f6c632_u128},
        {Sign::NEG, -141, 0xfffc001554d558887333c57857e1ed52_u128},
        {Sign::NEG, -142, 0xfffe00055545558887dde026fa704374_u128},
        {Sign::NEG, 0, 0_u128},
        {Sign::POS, -141, 0x80010002aab2aac444999abe2fe2cc65_u128},
        {Sign::POS, -140, 0x8002000aaaeaac444eef381581464ccb_u128},
        {Sign::POS, -140, 0xc004802401440c26dfeb485085f6f454_u128},
        {Sign::POS, -139, 0x8004002aacaac44599abe3be3a1c6e93_u128},
        {Sign::POS, -139, 0xa00640535a37a37a6bc1e20eac8448b4_u128},
        {Sign::POS, -139, 0xc00900900a20c275979eedc064c242fd_u128},
        {Sign::POS, -139, 0xe00c40e4bd6e4efdc72446cc1bf728bd_u128},
        {Sign::POS, -138, 0x800800aabaac446ef381b821bbb569e5_u128},
        {Sign::POS, -138, 0x900a20f319a3e273569b26aaa485ea5c_u128},
        {Sign::POS, -138, 0xa00c814d7c6a37f82dcf56c83c80b028_u128},
        {Sign::POS, -138, 0xb00f21bbe3e388ee5f69768284463b9b_u128},
        {Sign::POS, -138, 0xc0120240510c284cb48ea6c05e2773a1_u128},
        {Sign::POS, -138, 0xd01522dcc4f8799114d9d76196d8043a_u128},
        {Sign::POS, -138, 0xe018839340d4f241e016a611a4415d72_u128},
        {Sign::POS, -138, 0xf01c2465c5e61b6f661e135f49a47c40_u128},
        {Sign::POS, -137, 0x801002ab2ac4499abe6bf0fa435e8383_u128},
        {Sign::POS, -137, 0x881213337898871e9a31ba0cbc030353_u128},
        {Sign::POS, -137, 0x901443cccd362c9f54b57dfe0c4c840f_u128},
        {Sign::POS, -137, 0x98169478296fad417ad1e9c315328f7e_u128},
        {Sign::POS, -137, 0xa01905368e2389b31f3f686cf3d6be22_u128},
        {Sign::POS, -137, 0xa81b9608fc3c50ecf105b66ec4703ede_u128},
        {Sign::POS, -137, 0xb01e46f074b0a0f3610848c68df4d233_u128},
        {Sign::POS, -137, 0xb82117edf8832797d6aef30cd312169a_u128},
        {Sign::POS, -137, 0xc024090288c2a339f3ac379608053d9d_u128},
        {Sign::POS, -137, 0xc8271a2f2689e388e6e2acf8f4d4c24a_u128},
        {Sign::POS, -137, 0xd02a4b74d2ffca44ce6ae474d860359f_u128},
        {Sign::POS, -137, 0xd82d9cd48f574c0028bb3cd9f2a65fb5_u128},
        {Sign::POS, -137, 0xe0310e4f5ccf70e154f30dbef38a8066_u128},
        {Sign::POS, -137, 0xe8349fe63cb35564224a96f5a7471c46_u128},
        {Sign::POS, -137, 0xf038519a305a2b1b6ea920591aa02e1b_u128},
        {Sign::POS, -137, 0xf83c236c39273972d462b63756c87e80_u128},
        {Sign::POS, -136, 0x80200aaeac44ef38338f77605fe77f2a_u128},
        {Sign::POS, -136, 0x842213b747fec7bb3ff51287882500ed_u128},
        {Sign::POS, -136, 0x88242cd07084ed02cc394b3ef0ebeb12_u128},
        {Sign::POS, -136, 0x8c2655faa6a1323f1ab9679b55f78a6b_u128},
        {Sign::POS, -136, 0x90288f366b2377717025697d10af0436_u128},
        {Sign::POS, -136, 0x942ad8843ee1a9cd17e4b7ac6c600cb4_u128},
        {Sign::POS, -136, 0x982d31e4a2b7c4187013925a9a8da7f3_u128},
        {Sign::POS, -136, 0x9c2f9b581787cf0dfd1a09c848e3950e_u128},
        {Sign::POS, -136, 0xa03214df1e39e1bd84dd2de6e3d90a37_u128},
        {Sign::POS, -136, 0xa4349e7a37bc21ed318b2ddd9d0a33b4_u128},
        {Sign::POS, -136, 0xa8373829e502c47abc031e6f5acfd4a8_u128},
        {Sign::POS, -136, 0xac39e1eea7080dbc9dd91e52c79fd070_u128},
        {Sign::POS, -136, 0xb03c9bc8fecc51e34af78fa1cb48a12d_u128},
        {Sign::POS, -136, 0xb43f65b96d55f55a72de1d99ce252efd_u128},
        {Sign::POS, -136, 0xb74187bc8ccffa84efb1dbe721934877_u128},
        {Sign::POS, -136, 0xbb446dd4d9bca499b4b080f230c87598_u128},
        {Sign::POS, -136, 0xbf476404a05f88f2da6a7cd19c7fa4f2_u128},
        {Sign::POS, -136, 0xc34a6a4c61d5cc3cdf00e3783b50ecfb_u128},
        {Sign::POS, -136, 0xc74d80ac9f42a52dda2e5e02ab4e183c_u128},
        {Sign::POS, -136, 0xcb50a725d9cf5ce6ea5f6ee99d30c626_u128},
        {Sign::POS, -136, 0xcf53ddb892ab4f55a96d5956531d7d8b_u128},
        {Sign::POS, -136, 0xd35724654b0beb95a8fc636eb36afa75_u128},
        {Sign::POS, -136, 0xd75a7b2c842cb451f67e2b827bfc4421_u128},
        {Sign::POS, -136, 0xdb5de20ebf4f4026a6d8c817516303e6_u128},
        {Sign::POS, -136, 0xdf61590c7dbb3a0269b36ae5962e85f4_u128},
        {Sign::POS, -136, 0xe364e02640be618824693eec2a831cc3_u128},
        {Sign::POS, -136, 0xe768775c89ac8b7094a339d56a55ab4a_u128},
        {Sign::POS, -136, 0xeb6c1eafd9dfa1ebfa9998fbf9703bf4_u128},
        {Sign::POS, -136, 0xef6fd620b2b7a503cafdc27227b71eaa_u128},
        {Sign::POS, -136, 0xf3739daf959aaafc688d4282f6026aa3_u128},
        {Sign::POS, -136, 0xf777755d03f4e0b6e54e9e3804464cdd_u128},
        {Sign::POS, -136, 0xfb7b5d297f388a12cb78b383f4b59dce_u128},
        {Sign::POS, -136, 0xff7f551588de024fee055fc515062c04_u128},
        {Sign::POS, -135, 0x81c1ae90d131de38207812b43382acdd_u128},
        {Sign::POS, -135, 0x83c3baa726a721ccdc90c4c4b61f3a87_u128},
        {Sign::POS, -135, 0x85c5cece05941dbc1a03f13fb2c978b1_u128},
        {Sign::POS, -135, 0x87c7eb05aec1304fb36f282e83a7dc36_u128},
        {Sign::POS, -135, 0x89ca0f4e62f9c4766ad14c3dfa414391_u128},
        {Sign::POS, -135, 0x8bcc3ba8630c51f4e8dd4ea0d48b88e5_u128},
        {Sign::POS, -135, 0x8dce7013efca5d96c02515afe8caeb90_u128},
        {Sign::POS, -135, 0x8fd0ac914a08795f741ceaf3349f3cf1_u128},
        {Sign::POS, -135, 0x91d2f120b29e44bb83f7cd4929d2c28c_u128},
        {Sign::POS, -135, 0x93d53dc26a666cb1795d03ebc2fd03fa_u128},
        {Sign::POS, -135, 0x95d79276b23eac12faf74f1d1ad16acc_u128},
        {Sign::POS, -135, 0x97d9ef3dcb07cbade2de134f72fee429_u128},
        {Sign::POS, -135, 0x99dc5417f5a5a27d58d8dba6cadac5d5_u128},
        {Sign::POS, -135, 0x9bdec10572ff15daf07d90bc5aae40a4_u128},
        {Sign::POS, -135, 0x9d6098046659ea6b1deaf79d9fc40374_u128},
        {Sign::POS, -135, 0x9f63131450b079887ba63e6769b81999_u128},
        {Sign::POS, -135, 0xa1659638404d5f9259ebfc9335094e59_u128},
        {Sign::POS, -135, 0xa36821707622f97a16aae012b5026f71_u128},
        {Sign::POS, -135, 0xa56ab4bd3326b378ff5d4f2c0e4b9cae_u128},
        {Sign::POS, -135, 0xa76d501eb8510941855838b5119dcb28_u128},
        {Sign::POS, -135, 0xa96ff395469d863075f70cbbe9cf1603_u128},
        {Sign::POS, -135, 0xab729f211f0ac57e36a53ad4d5541cc9_u128},
        {Sign::POS, -135, 0xad7552c2829a727004c5934ec32d20d9_u128},
        {Sign::POS, -135, 0xaf780e79b25148893977e89aec59bfa2_u128},
        {Sign::POS, -135, 0xb17ad246ef3713bc913d4e3dc55c3e6e_u128},
        {Sign::POS, -135, 0xb37d9e2a7a56b09d777b52a9e70d8bcc_u128},
        {Sign::POS, -135, 0xb580722494be0c9155de916fd30591de_u128},
        {Sign::POS, -135, 0xb7834e357f7e2600e79cfb37be2861e4_u128},
        {Sign::POS, -135, 0xb986325d7bab0c8990983104d3805389_u128},
        {Sign::POS, -135, 0xbb891e9cca5be12eb860504baa6f984d_u128},
        {Sign::POS, -135, 0xbd8c12f3acaad68b29178d6ff5712b96_u128},
        {Sign::POS, -135, 0xbf8f0f6263b531027236fa47ba19a198_u128},
        {Sign::POS, -135, 0xc19213e9309b46f24f34d64cafcc50e3_u128},
        {Sign::POS, -135, 0xc3952088548080e4120cc62eb0a8db3e_u128},
        {Sign::POS, -135, 0xc5983540108b59be11aa5084779060e3_u128},
        {Sign::POS, -135, 0xc79b5210a5e55ef51c35fd6236c8dcf1_u128},
        {Sign::POS, -135, 0xc99e76fa55bb30bded4576a7e4b878fe_u128},
        {Sign::POS, -135, 0xcb20d7fa3a3360816caf4bb8fd2c1131_u128},
        {Sign::POS, -135, 0xcd240b10753e78de3f24a6cbb09c654f_u128},
        {Sign::POS, -135, 0xcf2746407e0ff09f78bc003bb81e40f3_u128},
        {Sign::POS, -135, 0xd12a898a95dff00256647301edfd8e8b_u128},
        {Sign::POS, -135, 0xd32dd4eefde9b2ef28fe1c4d04ca4ed9_u128},
        {Sign::POS, -135, 0xd531286df76b892ae1ea9ea6cbf57379_u128},
        {Sign::POS, -135, 0xd7348407c3a6d688a3832028141a5cc2_u128},
        {Sign::POS, -135, 0xd937e7bca3e0131b557421dd379d3ead_u128},
        {Sign::POS, -135, 0xdb3b538cd95ecb673cff8e87a99bcaf0_u128},
        {Sign::POS, -135, 0xdd3ec778a56da09399255ef34bd0801f_u128},
        {Sign::POS, -135, 0xdf424380495a489c42b33220abfa15cd_u128},
        {Sign::POS, -135, 0xe145c7a406758e83503b378faa97dbc0_u128},
        {Sign::POS, -135, 0xe34953e41e135282bdf2ca006f59b544_u128},
        {Sign::POS, -135, 0xe54ce840d18a8a3e1979190af37ed16f_u128},
        {Sign::POS, -135, 0xe75084ba623540f431863ff7cf898c9c_u128},
        {Sign::POS, -135, 0xe9542951117097b0c983284f60293647_u128},
        {Sign::POS, -135, 0xeb57d605209cc57e510a969ebe03f804_u128},
        {Sign::POS, -135, 0xed5b8ad6d11d17979f53bffc6d23fe30_u128},
        {Sign::POS, -135, 0xef5f47c66457f199b286c6e113337886_u128},
        {Sign::POS, -135, 0xf0e21acdd6e7d412b6ed80852ae6fd63_u128},
        {Sign::POS, -135, 0xf2e5e5f25450c5a2df437fb0f616082d_u128},
        {Sign::POS, -135, 0xf4e9b935685dbe0bf237cff1acb306b3_u128},
        {Sign::POS, -135, 0xf6ed94975480b69652dbfafb4121a092_u128},
        {Sign::POS, -135, 0xf8f178185a2ebfd90d81648249cece4c_u128},
        {Sign::POS, -135, 0xfaf563b8bae001ebad95e6b0b96903d3_u128},
        {Sign::POS, -135, 0xfcf95778b80fbc98176cd56887ac7fe9_u128},
        {Sign::POS, -135, 0xfefd5358933c478c65f4c7397f1f478d_u128},
    },
    // -log(r) for the third step, generated by SageMath with:
    //
    // for i in range(-80, 81):
    //   r = 2^-21 * round( 2^21 / (1 + i*2^(-21)) );
    //   s, m, e = RealField(128)(r).log().sign_mantissa_exponent();
    //   print("{Sign::POS," if (s == -1) else "{Sign::NEG,", e, ",
    //         hex(m), "_u128},");
    /* .step_3 = */
    {
        {Sign::NEG, -142, 0x9fff38014d52e45a374b294076d669c3_u128},
        {Sign::NEG, -142, 0x9dff3cf940fad85a7f6f05dcdbeb776e_u128},
        {Sign::NEG, -142, 0x9bff41e134f1cb363d55e21d41bbadf9_u128},
        {Sign::NEG, -142, 0x99ff46b92936bcf4ccdba2d54aadbc5c_u128},
        {Sign::NEG, -142, 0x97ff4b811dc8ad9d71dd16d3073f79b2_u128},
        {Sign::NEG, -142, 0x95ff503912a69d375837f3df1a58dd48_u128},
        {Sign::NEG, -142, 0x93ff54e107cf8bc993cad3bcdd26fd6d_u128},
        {Sign::NEG, -142, 0x91ff5978fd42795b2075312a827f14fa_u128},
        {Sign::NEG, -142, 0x8fff5e00f2fe65f2e21764e139c98f60_u128},
        {Sign::NEG, -142, 0x8dff6278e9025197a492a29551751b4c_u128},
        {Sign::NEG, -142, 0x8bff66e0df4d3c501bc8f5f658f1c3a2_u128},
        {Sign::NEG, -142, 0x89ff6b38d5de2622e39d3faf42340ed7_u128},
        {Sign::NEG, -142, 0x87ff6f80ccb40f167ff3326682c02485_u128},
        {Sign::NEG, -142, 0x85ff73b8c3cdf7315caf4fbe343cf928_u128},
        {Sign::NEG, -142, 0x83ff77e0bb2ade79cdb6e554348f7fe8_u128},
        {Sign::NEG, -142, 0x81ff7bf8b2c9c4f60ef009c2457de25d_u128},
        {Sign::NEG, -143, 0xffff0001555355588883333c57b57c74_u128},
        {Sign::NEG, -143, 0xfbff07f145931f44f32668f39c70d183_u128},
        {Sign::NEG, -143, 0xf7ff0fc13650e7bd459a73c6a6486fe3_u128},
        {Sign::NEG, -143, 0xf3ff1771278aaecd37b18cca7dd3a29f_u128},
        {Sign::NEG, -143, 0xefff1f01193e7480513f610d21bcfc78_u128},
        {Sign::NEG, -143, 0xebff26710b6a38e1ea190b95c0690b7b_u128},
        {Sign::NEG, -143, 0xe7ff2dc0fe0bfbfd2a150f64f0ad1743_u128},
        {Sign::NEG, -143, 0xe3ff34f0f121bddd090b5174e995e9d1_u128},
        {Sign::NEG, -143, 0xdfff3c00e4a97e8c4ed512b9b93ea2bf_u128},
        {Sign::NEG, -143, 0xdbff42f0d8a13e15934cea217ab794a2_u128},
        {Sign::NEG, -143, 0xd7ff49c0cd06fc833e4ebe948afd2c76_u128},
        {Sign::NEG, -143, 0xd3ff5070c1d8b9df87b7c0f5bcfee2e1_u128},
        {Sign::NEG, -143, 0xcfff5700b7147634776666228cb6371b_u128},
        {Sign::NEG, -143, 0xcbff5d70acb8318be53a60f3514db358_u128},
        {Sign::NEG, -143, 0xc7ff63c0a2c1ebef79149c3b6e57fa86_u128},
        {Sign::NEG, -143, 0xc3ff69f0992fa568aad734c98416df2a_u128},
        {Sign::NEG, -143, 0xbfff70008fff5e00c26573679ed28334_u128},
        {Sign::NEG, -143, 0xbbff75f0872f15c0d7a3c6db6540809f_u128},
        {Sign::NEG, -143, 0xb7ff7bc07ebcccb1d277bde645fb1aad_u128},
        {Sign::NEG, -143, 0xb3ff817076a682dc6ac80145a4087793_u128},
        {Sign::NEG, -143, 0xafff87006eea3849287c4db30271e265_u128},
        {Sign::NEG, -143, 0xabff8c706785ed00637d6de42eeb151e_u128},
        {Sign::NEG, -143, 0xa7ff91c06077a10a43b5348b6b898a8c_u128},
        {Sign::NEG, -143, 0xa3ff96f059bd546ec10e7657978bd7f6_u128},
        {Sign::NEG, -143, 0x9fff9c0053550735a37503f457310e59_u128},
        {Sign::NEG, -143, 0x9bffa0f04d3cb96682d5a40a3aa022ff_u128},
        {Sign::NEG, -143, 0x97ffa5c047726b08c71e0d3ee3df5f4d_u128},
        {Sign::NEG, -143, 0x93ffaa7041f41c23a83ce0352bdbd79b_u128},
        {Sign::NEG, -143, 0x8fffaf003cbfccbe2e21a18d4680e8e4_u128},
        {Sign::NEG, -143, 0x8bffb37037d37cdf30bcb3e4e5dfbd28_u128},
        {Sign::NEG, -143, 0x87ffb7c0332d2c8d57ff51d75c66d64a_u128},
        {Sign::NEG, -143, 0x83ffbbf02ecadbcf1bdb87fdbe299f43_u128},
        {Sign::NEG, -144, 0xffff80005555155588885dde02700703_u128},
        {Sign::NEG, -144, 0xf7ff87e04d94724cd259ca803a0c1870_u128},
        {Sign::NEG, -144, 0xefff8f80464fce8fe514130851c7070a_u128},
        {Sign::NEG, -144, 0xe7ff96e03f832a2a30a16898f3073a64_u128},
        {Sign::NEG, -144, 0xdfff9e00392a8526c4ed64517b2949ce_u128},
        {Sign::NEG, -144, 0xd7ffa4e03341df9051e4fb4e32cf6350_u128},
        {Sign::NEG, -144, 0xcfffab802dc53971277672a88350bcce_u128},
        {Sign::NEG, -144, 0xc7ffb1e028b092d3359153772a490f06_u128},
        {Sign::NEG, -144, 0xbfffb80023ffebc00c265ece6b481a0e_u128},
        {Sign::NEG, -144, 0xb7ffbde01faf4440db2781c03fa132f6_u128},
        {Sign::NEG, -144, 0xafffc3801bba9c5e7287c95c845ada33_u128},
        {Sign::NEG, -144, 0xa7ffc8e0181df421423b56b1263e5a77_u128},
        {Sign::NEG, -144, 0x9fffce0014d54b915a3752ca4c076fa3_u128},
        {Sign::NEG, -144, 0x97ffd2e011dca2b66a71e2b27eb3f573_u128},
        {Sign::NEG, -144, 0x8fffd7800f2ff997c2e21b72cff39d8f_u128},
        {Sign::NEG, -144, 0x87ffdbe00ccb503c537ff612feb7ac9e_u128},
        {Sign::NEG, -145, 0xffffc00015554d555888873333c57c18_u128},
        {Sign::NEG, -145, 0xefffc7c01193f9d1fa51421842311c42_u128},
        {Sign::NEG, -145, 0xdfffcf000e4aa5fa2c4ed6de475b942c_u128},
        {Sign::NEG, -145, 0xcfffd5c00b7151d8ce77678cbb6fcb88_u128},
        {Sign::NEG, -145, 0xbfffdc0008fffd7800c26629a679ed3b_u128},
        {Sign::NEG, -145, 0xafffe1c006eea8e123287cb9d3072728_u128},
        {Sign::NEG, -145, 0x9fffe7000535541cd5a37540fd057315_u128},
        {Sign::NEG, -145, 0x8fffebc003cbff32f82e21c1fce36810_u128},
        {Sign::NEG, -146, 0xffffe000055554555588887ddde02702_u128},
        {Sign::NEG, -146, 0xdfffe7800392aa149ac4ed72adf5b295_u128},
        {Sign::NEG, -146, 0xbfffee00023fffaf000c26648066b482_u128},
        {Sign::NEG, -146, 0x9ffff380014d552e455a3754b292c077_u128},
        {Sign::NEG, -147, 0xfffff000015555355558888833333c58_u128},
        {Sign::NEG, -147, 0xbffff700008ffff5e000c2665736679f_u128},
        {Sign::NEG, -148, 0xfffff800005555515555888885ddde02_u128},
        {Sign::NEG, -149, 0xfffffc0000155554d555588888733334_u128},
        {Sign::POS, 0, 0_u128},
        {Sign::POS, -148, 0x80000200000aaaaaeaaaac44444eeeef_u128},
        {Sign::POS, -147, 0x80000400002aaaacaaaac444459999ac_u128},
        {Sign::POS, -147, 0xc00009000090000a2000c2667596679f_u128},
        {Sign::POS, -146, 0x8000080000aaaabaaaac44446eeef381_u128},
        {Sign::POS, -146, 0xa0000c80014d557c655a3755f81815cc_u128},
        {Sign::POS, -146, 0xc000120002400051000c26684c66b482_u128},
        {Sign::POS, -146, 0xe00018800392ab40bac4ed7c40fb07eb_u128},
        {Sign::POS, -145, 0x8000100002aaab2aaac44449999abe2c_u128},
        {Sign::POS, -145, 0x9000144003cc00cd082e21d79cbb6812_u128},
        {Sign::POS, -145, 0xa00019000535568dd5a37569adb01dc3_u128},
        {Sign::POS, -145, 0xb0001e4006eeac7433287d01e8c9d1d9_u128},
        {Sign::POS, -145, 0xc00024000900028800c266a32679ed48_u128},
        {Sign::POS, -145, 0xd0002a400b7158d1de77685122b2764b_u128},
        {Sign::POS, -145, 0xe00031000e4aaf5b2c4ed810a8063f03_u128},
        {Sign::POS, -145, 0xf00038401194062e0a5143e7be891c8f_u128},
        {Sign::POS, -144, 0x800020000aaaaeaaac4444eeef3813a1_u128},
        {Sign::POS, -144, 0x880024200ccb5a6e5b7ff7fe1339025b_u128},
        {Sign::POS, -144, 0x900028800f30066842e21e26caf39e33_u128},
        {Sign::POS, -144, 0x98002d2011dcb29ef271e66fa5554bc6_u128},
        {Sign::POS, -144, 0xa000320014d55f195a3757e0615cc676_u128},
        {Sign::POS, -144, 0xa8003720181e0bdeca3b5d8210ca5cab_u128},
        {Sign::POS, -144, 0xb0003c801bbab8f6f287d25f3cb032bb_u128},
        {Sign::POS, -144, 0xb80042201faf6669e3278d840be28cdb_u128},
        {Sign::POS, -144, 0xc0004800240014400c266dfe6b482076_u128},
        {Sign::POS, -144, 0xc8004e2028b0c2823d9166de380a6d3d_u128},
        {Sign::POS, -144, 0xd00054802dc57139a7768b356ba61e4b_u128},
        {Sign::POS, -144, 0xd8005b203342206fd9e51a1849db73c1_u128},
        {Sign::POS, -144, 0xe0006200392ad02ec4ed8a9d907eb521_u128},
        {Sign::POS, -144, 0xe80069203f838080b8a197dea928acd7_u128},
        {Sign::POS, -144, 0xf00070804650317065144cf7dcc72d3b_u128},
        {Sign::POS, -144, 0xf80078204d94e308da5a1108890d9f6a_u128},
        {Sign::POS, -143, 0x800040002aaacaaac4445999abe2ce2c_u128},
        {Sign::POS, -143, 0x840044102ecb24311fdbbb4f3bffc832_u128},
        {Sign::POS, -143, 0x88004840332d7e1d97ff8f39ec91b4ee_u128},
        {Sign::POS, -143, 0x8c004c9037d3d87674bcfcf0b3f0a95d_u128},
        {Sign::POS, -143, 0x900051003cc033422e21f80ca6813aff_u128},
        {Sign::POS, -143, 0x9400559041f48e876c3d4629170ce87f_u128},
        {Sign::POS, -143, 0x98005a404772ea4d071e84e3b80a8881_u128},
        {Sign::POS, -143, 0x9c005f104d3d469a06d62fdcbdd6bec3_u128},
        {Sign::POS, -143, 0xa00064005355a375a375a6b701dc77c0_u128},
        {Sign::POS, -143, 0xa400691059be00e7450f331826ad6b05_u128},
        {Sign::POS, -143, 0xa8006e4060785ef683b60ea8bd0aa459_u128},
        {Sign::POS, -143, 0xac0073906786bdab277e691469dd13f5_u128},
        {Sign::POS, -143, 0xb00079006eeb1d0d287d6e0a0d1e25eb_u128},
        {Sign::POS, -143, 0xb4007e9076a77d24aec94b3be9b060f5_u128},
        {Sign::POS, -143, 0xb80084407ebdddfa1279365fce280cce_u128},
        {Sign::POS, -143, 0xbc008a1087303f95dba5732f3e83e04a_u128},
        {Sign::POS, -143, 0xc00090009000a200c26759679ed5b754_u128},
        {Sign::POS, -143, 0xc400961099310543aed95aca5edb5109_u128},
        {Sign::POS, -143, 0xc8009c40a2c36967b917091d2687160f_u128},
        {Sign::POS, -143, 0xcc00a290acb9ce76293d1c2a0378e75d_u128},
        {Sign::POS, -143, 0xd000a900b7163478776977bf9766f5a7_u128},
        {Sign::POS, -143, 0xd400af90c1da9b784bbb31b14776a18b_u128},
        {Sign::POS, -143, 0xd800b640cd09037f7e5297d76c8564ba_u128},
        {Sign::POS, -143, 0xdc00bd10d8a36c981751360f8461c447_u128},
        {Sign::POS, -143, 0xe000c400e4abd6cc4ed9dc3c63f44c41_u128},
        {Sign::POS, -143, 0xe400cb10f12442268d10a4466a5894d5_u128},
        {Sign::POS, -143, 0xe800d240fe0eaeb16a1af81bb4e6510e_u128},
        {Sign::POS, -143, 0xec00d9910b6d1c77ae1f97b0542a677a_u128},
        {Sign::POS, -143, 0xf000e10119418b8451469efe81d014cc_u128},
        {Sign::POS, -143, 0xf400e891278dfbe27bb98c06d77a18b4_u128},
        {Sign::POS, -143, 0xf800f04136546d9d85a344d0868bed17_u128},
        {Sign::POS, -143, 0xfc00f8114596e0c0f7301d6990e307cc_u128},
        {Sign::POS, -142, 0x80008000aaabaaac4446eef38140138f_u128},
        {Sign::POS, -142, 0x82008408b2cbe5b810f5e43296105497_u128},
        {Sign::POS, -142, 0x84008820bb2d2189edbd4f83ef63f730_u128},
        {Sign::POS, -142, 0x86008c48c3d05e27feb654fd541c638e_u128},
        {Sign::POS, -142, 0x88009080ccb69b987ffadeb8882f7674_u128},
        {Sign::POS, -142, 0x8a0094c8d5e0d9e1c5a59fd36bd44397_u128},
        {Sign::POS, -142, 0x8c009920df50190a3bd217701b27dddb_u128},
        {Sign::POS, -142, 0x8e009d88e9055918669c93b50e4a2595_u128},
        {Sign::POS, -142, 0x9000a200f3019a12e22234cd39f29cd4_u128},
        {Sign::POS, -142, 0x9200a688fd45dc006280efe8307d41d9_u128},
        {Sign::POS, -142, 0x9400ab2107d31ee7b3d7923a436f6fc4_u128},
        {Sign::POS, -142, 0x9600afc912aa62cfba45c3fca574c5a0_u128},
        {Sign::POS, -142, 0x9800b4811dcca7bf71ec0b6d8cd413d1_u128},
        {Sign::POS, -142, 0x9a00b949293aedbdeeebcfd0565c5006_u128},
        {Sign::POS, -142, 0x9c00be2134f634d25d675c6da8c98fc3_u128},
        {Sign::POS, -142, 0x9e00c30940ff7d040181e39398a2099a_u128},
        {Sign::POS, -142, 0xa000c8014d57c65a375f8195cc8b1d29_u128},

    },
    // -log(r) for the fourth step, generated by SageMath with:
    //
    // for i in range(-65, 65):
    //   r = 2^-28 * round( 2^28 / (1 + i*2^(-28)) );
    //   s, m, e = RealField(128)(r).log().sign_mantissa_exponent();
    //   print("{Sign::POS," if (s == -1) else "{Sign::NEG,", e, ",
    //         hex(m), "_u128},");
    /* .step_4 = */
    {
        {Sign::NEG, -149, 0x81fffef7f002cb2b4cd24d68ff2f11ae_u128},
        {Sign::NEG, -150, 0xfffffe0000055555455555888887ddde_u128},
        {Sign::NEG, -150, 0xfbfffe0fe0051653f0fa101f52b3971f_u128},
        {Sign::NEG, -150, 0xf7fffe1f8004d94a9c9329d659ed3734_u128},
        {Sign::NEG, -150, 0xf3fffe2ee0049e314821006d9b58462e_u128},
        {Sign::NEG, -150, 0xeffffe3e000464fff3a3f025142f8c21_u128},
        {Sign::NEG, -150, 0xebfffe4ce0042dae9f1c53bcc1c4b11c_u128},
        {Sign::NEG, -150, 0xe7fffe5b8003f8354a8a8474a17fdd30_u128},
        {Sign::NEG, -150, 0xe3fffe69e003c48bf5eeda0cb0df586d_u128},
        {Sign::NEG, -150, 0xdffffe78000392aaa149aac4ed772adf_u128},
        {Sign::NEG, -150, 0xdbfffe85e00362894c9b4b5d54f0bc96_u128},
        {Sign::NEG, -150, 0xd7fffe938003341ff7e40f15e50a759f_u128},
        {Sign::NEG, -150, 0xd3fffea0e0030766a32447ae9b975e05_u128},
        {Sign::NEG, -150, 0xcffffeae0002dc554e5c4567767ebdd5_u128},
        {Sign::NEG, -150, 0xcbfffebae002b2e3f98c570073bbbd19_u128},
        {Sign::NEG, -150, 0xc7fffec780028b0aa4b4c9b9915d03dd_u128},
        {Sign::NEG, -150, 0xc3fffed3e00264c14fd5e952cd845a28_u128},
        {Sign::NEG, -150, 0xbffffee000023ffffaf0000c26664806_u128},
        {Sign::NEG, -150, 0xbbfffeebe0021cbea60356a59a49b57f_u128},
        {Sign::NEG, -150, 0xb7fffef78001faf55110345f27878a9b_u128},
        {Sign::NEG, -150, 0xb3ffff02e001da9bfc16def8cc8a4f61_u128},
        {Sign::NEG, -150, 0xafffff0e0001bbaaa7179ab287cdcbd8_u128},
        {Sign::NEG, -150, 0xabffff18e0019e195212aa4c57dea809_u128},
        {Sign::NEG, -150, 0xa7ffff23800181dffd084f063b5a0bf8_u128},
        {Sign::NEG, -150, 0xa3ffff2de00166f6a7f8c8a030ed3fab_u128},
        {Sign::NEG, -150, 0x9fffff3800014d5552e4555a37554b29_u128},
        {Sign::NEG, -150, 0x9bffff41e00134f3fdcb31f44d5e9676_u128},
        {Sign::NEG, -150, 0x97ffff4b80011dcaa8ad99ae71e48997_u128},
        {Sign::NEG, -150, 0x93ffff54e00107d1538bc648a3d12c90_u128},
        {Sign::NEG, -150, 0x8fffff5e0000f2fffe65f002e21cc765_u128},
        {Sign::NEG, -150, 0x8bffff66e000df4ea93c4d9d2bcd821a_u128},
        {Sign::NEG, -150, 0x87ffff6f8000ccb5540f14577ff704b2_u128},
        {Sign::NEG, -150, 0x83ffff77e000bb2bfede77f1ddba1731_u128},
        {Sign::NEG, -151, 0xffffff00000155555355555888888333_u128},
        {Sign::NEG, -151, 0xf7ffff0fc0013652a8e7ba8d659ed7dc_u128},
        {Sign::NEG, -151, 0xefffff1f0001193ffe747e025142fc61_u128},
        {Sign::NEG, -151, 0xe7ffff2dc000fe0d53fbfb374a1800c7_u128},
        {Sign::NEG, -151, 0xdfffff3c0000e4aaa97e8aac4ed77513_u128},
        {Sign::NEG, -151, 0xd7ffff49c000cd07fefc81e15e50a947_u128},
        {Sign::NEG, -151, 0xcfffff570000b715547633567767ed66_u128},
        {Sign::NEG, -151, 0xc7ffff63c000a2c2a9ebee8b9915d174_u128},
        {Sign::NEG, -151, 0xbfffff7000008fffff5e0000c2666573_u128},
        {Sign::NEG, -151, 0xb7ffff7bc0007ebd54ccb135f2787966_u128},
        {Sign::NEG, -151, 0xafffff8700006eeaaa3848ab287cdd4e_u128},
        {Sign::NEG, -151, 0xa7ffff91c0006077ffa109e063b5a12d_u128},
        {Sign::NEG, -151, 0x9fffff9c0000535555073555a3755504_u128},
        {Sign::NEG, -151, 0x97ffffa5c0004772aa6b088ae71e48d5_u128},
        {Sign::NEG, -151, 0x8fffffaf00003cbfffccbe002e21cca2_u128},
        {Sign::NEG, -151, 0x87ffffb7c000332d552c8d3577ff706a_u128},
        {Sign::NEG, -152, 0xffffff8000005555551555558888885e_u128},
        {Sign::NEG, -152, 0xefffff8f8000464fffce8fc025142fe3_u128},
        {Sign::NEG, -152, 0xdfffff9e0000392aaa8526aac4ed7764_u128},
        {Sign::NEG, -152, 0xcfffffab80002dc55539711567767ee3_u128},
        {Sign::NEG, -152, 0xbfffffb8000023ffffebc0000c26665f_u128},
        {Sign::NEG, -152, 0xafffffc380001bbaaa9c5e6ab287cdd9_u128},
        {Sign::NEG, -152, 0x9fffffce000014d5554b91555a375553_u128},
        {Sign::NEG, -152, 0x8fffffd780000f2ffff997c002e21ccb_u128},
        {Sign::NEG, -153, 0xffffffc000001555554d555558888887_u128},
        {Sign::NEG, -153, 0xdfffffcf00000e4aaaa5fa2aac4ed777_u128},
        {Sign::NEG, -153, 0xbfffffdc000008fffffd780000c26666_u128},
        {Sign::NEG, -153, 0x9fffffe70000053555541cd555a37555_u128},
        {Sign::NEG, -154, 0xffffffe0000005555554555555888888_u128},
        {Sign::NEG, -154, 0xbfffffee0000023fffffaf00000c2666_u128},
        {Sign::NEG, -155, 0xfffffff0000001555555355555588889_u128},
        {Sign::NEG, -156, 0xfffffff8000000555555515555558889_u128},
        {Sign::POS, 0, 0_u128},
        {Sign::POS, -155, 0x800000040000002aaaaaacaaaaaac444_u128},
        {Sign::POS, -154, 0x80000008000000aaaaaabaaaaaac4444_u128},
        {Sign::POS, -154, 0xc00000120000024000005100000c2666_u128},
        {Sign::POS, -153, 0x80000010000002aaaaab2aaaaac44444_u128},
        {Sign::POS, -153, 0xa00000190000053555568dd555a37555_u128},
        {Sign::POS, -153, 0xc0000024000009000002880000c26667_u128},
        {Sign::POS, -153, 0xe000003100000e4aaaaf5b2aac4ed778_u128},
        {Sign::POS, -152, 0x8000002000000aaaaaaeaaaaac444445_u128},
        {Sign::POS, -152, 0x9000002880000f300006684002e21cce_u128},
        {Sign::POS, -152, 0xa0000032000014d5555f19555a375558_u128},
        {Sign::POS, -152, 0xb000003c80001bbaaab8f6eab287cde2_u128},
        {Sign::POS, -152, 0xc000004800002400001440000c26666e_u128},
        {Sign::POS, -152, 0xd000005480002dc55571399567767efb_u128},
        {Sign::POS, -152, 0xe00000620000392aaad02eaac4ed778b_u128},
        {Sign::POS, -152, 0xf000007080004650003170402514301d_u128},
        {Sign::POS, -151, 0x8000004000002aaaaacaaaaac444445a_u128},
        {Sign::POS, -151, 0x880000484000332d557e1d7577ff70a7_u128},
        {Sign::POS, -151, 0x9000005100003cc0003342002e21ccf8_u128},
        {Sign::POS, -151, 0x9800005a40004772aaea4ccae71e494d_u128},
        {Sign::POS, -151, 0xa00000640000535555a37555a37555a7_u128},
        {Sign::POS, -151, 0xa800006e40006078005ef62063b5a207_u128},
        {Sign::POS, -151, 0xb000007900006eeaab1d0cab287cde6e_u128},
        {Sign::POS, -151, 0xb800008440007ebd55ddf975f2787ade_u128},
        {Sign::POS, -151, 0xc00000900000900000a20000c2666759_u128},
        {Sign::POS, -151, 0xc800009c4000a2c2ab6966cb9915d3e1_u128},
        {Sign::POS, -151, 0xd00000a90000b715563477567767f078_u128},
        {Sign::POS, -151, 0xd80000b64000cd0801037e215e50ad20_u128},
        {Sign::POS, -151, 0xe00000c40000e4aaabd6caac4ed779dc_u128},
        {Sign::POS, -151, 0xe80000d24000fe0d56aeaf774a1806b0_u128},
        {Sign::POS, -151, 0xf00000e100011940018b82025143039f_u128},
        {Sign::POS, -151, 0xf80000f040013652ac6d9acd659ee0ad_u128},
        {Sign::POS, -150, 0x800000800000aaaaabaaaaac444446ef_u128},
        {Sign::POS, -150, 0x840000882000bb2c01218811ddba1d9b_u128},
        {Sign::POS, -150, 0x880000908000ccb5569b96577ff70c5f_u128},
        {Sign::POS, -150, 0x8c0000992000df4eac1907bd2bcd8b3b_u128},
        {Sign::POS, -150, 0x900000a20000f300019a1002e21cd235_u128},
        {Sign::POS, -150, 0x940000ab200107d1571ee468a3d1394e_u128},
        {Sign::POS, -150, 0x980000b480011dcaaca7bbae71e4988b_u128},
        {Sign::POS, -150, 0x9c0000be200134f40234ce144d5ea7f0_u128},
        {Sign::POS, -150, 0xa00000c800014d5557c6555a37555f82_u128},
        {Sign::POS, -150, 0xa40000d2200166f6ad5c8cc030ed5744_u128},
        {Sign::POS, -150, 0xa80000dc800181e002f7b1063b5a273b_u128},
        {Sign::POS, -150, 0xac0000e720019e195898006c57dec76f_u128},
        {Sign::POS, -150, 0xb00000f20001bbaaae3dbab287cdefe3_u128},
        {Sign::POS, -150, 0xb40000fd2001da9c03e92118cc8a789f_u128},
        {Sign::POS, -150, 0xb80001088001faf5599a765f2787b9aa_u128},
        {Sign::POS, -150, 0xbc00011420021cbeaf51fec59a49eb0a_u128},
        {Sign::POS, -150, 0xc0000120000240000510000c266684c6_u128},
        {Sign::POS, -150, 0xc400012c200264c15ad4c172cd849ee9_u128},
        {Sign::POS, -150, 0xc800013880028b0ab0a08bb9915d5179_u128},
        {Sign::POS, -150, 0xcc0001452002b2e40673a92073bc1480_u128},
        {Sign::POS, -150, 0xd00001520002dc555c4e6567767f2009_u128},
        {Sign::POS, -150, 0xd400015f20030766b2310dce9b97cc1d_u128},
        {Sign::POS, -150, 0xd800016c80033420081bf115e50af0c7_u128},
        {Sign::POS, -150, 0xdc00017a200362895e0f5f7d54f14614_u128},
        {Sign::POS, -150, 0xe0000188000392aab40baac4ed77c410_u128},
        {Sign::POS, -150, 0xe40001962003c48c0a11262cb0e002c7_u128},
        {Sign::POS, -150, 0xe80001a48003f83560202674a1809a47_u128},
        {Sign::POS, -150, 0xec0001b320042daeb63901dcc1c582a0_u128},
        {Sign::POS, -150, 0xf00001c2000465000c5c1025143073df_u128},
        {Sign::POS, -150, 0xf40001d120049e316289aa8d9b594616_u128},
        {Sign::POS, -150, 0xf80001e08004d94ab8c22bd659ee5155_u128},
        {Sign::POS, -150, 0xfc0001f0200516540f05f03f52b4cdae_u128},
        {Sign::POS, -149, 0x800001000002aaaab2aaaac44444999a_u128},

    }};
// > P = fpminimax((log(1 + x) - x)/x^2, 2, [|1, 128...|],
//                 [-0x1.0002143p-29 , 0x1p-29]);
// > P;
// > dirtyinfnorm(log(1 + x)/x - x*P, [-0x1.0002143p-29 , 0x1p-29]);
// 0x1.99a3...p-121
const Float128 BIG_COEFFS[3]{
    {Sign::NEG, -129, 0x800000000006a710b59c58e5554d581c_u128},
    {Sign::POS, -129, 0xaaaaaaaaaaaaaabdde05c7c94ae9cbae_u128},
    {Sign::NEG, -128, 0x80000000000000000000000000000000_u128},
};

// Reuse the output of the fast pass range reduction.
// -2^-8 <= m_x < 2^-7
double log_accurate(int e_x, int index, double m_x) {

  Float128 e_x_f128(static_cast<float>(e_x));
  Float128 sum = fputil::quick_mul(LOG_2, e_x_f128);
  sum = fputil::quick_add(sum, LOG_TABLE.step_1[index]);

  Float128 v_f128 = log_range_reduction(m_x, LOG_TABLE, sum);
  sum = fputil::quick_add(sum, v_f128);

  // Polynomial approximation
  Float128 p = fputil::quick_mul(v_f128, BIG_COEFFS[0]);
  p = fputil::quick_mul(v_f128, fputil::quick_add(p, BIG_COEFFS[1]));
  p = fputil::quick_mul(v_f128, fputil::quick_add(p, BIG_COEFFS[2]));
  p = fputil::quick_mul(v_f128, p);

  Float128 r = fputil::quick_add(sum, p);

  return static_cast<double>(r);
}

} // namespace

LLVM_LIBC_FUNCTION(double, log, (double x)) {
  using FPBits_t = typename fputil::FPBits<double>;
  using Sign = fputil::Sign;
  FPBits_t xbits(x);
  uint64_t x_u = xbits.uintval();

  int x_e = -FPBits_t::EXP_BIAS;

  if (LIBC_UNLIKELY(xbits == FPBits_t::one())) {
    // log(1.0) = +0.0
    return 0.0;
  }

  if (LIBC_UNLIKELY(xbits.uintval() < FPBits_t::min_normal().uintval() ||
                    xbits.uintval() > FPBits_t::max_normal().uintval())) {
    if (xbits.is_zero()) {
      // return -Inf and raise FE_DIVBYZERO.
      fputil::set_errno_if_required(ERANGE);
      fputil::raise_except_if_required(FE_DIVBYZERO);
      return FPBits_t::inf(Sign::NEG).get_val();
    }
    if (xbits.is_neg() && !xbits.is_nan()) {
      fputil::set_errno_if_required(EDOM);
      fputil::raise_except_if_required(FE_INVALID);
      return FPBits_t::quiet_nan().get_val();
    }
    if (xbits.is_inf_or_nan()) {
      return x;
    }
    // Normalize denormal inputs.
    xbits = FPBits_t(x * 0x1.0p52);
    x_e -= 52;
    x_u = xbits.uintval();
  }

  // log(x) = log(2^x_e * x_m)
  //        = x_e * log(2) + log(x_m)

  // Range reduction for log(x_m):
  // For each x_m, we would like to find r such that:
  //   -2^-8 <= r * x_m - 1 < 2^-7
  int shifted = static_cast<int>(x_u >> 45);
  int index = shifted & 0x7F;
  double r = RD[index];

  // Add unbiased exponent. Add an extra 1 if the 8 leading fractional bits are
  // all 1's.
  x_e += static_cast<int>((x_u + (1ULL << 45)) >> 52);
  double e_x = static_cast<double>(x_e);

  // hi is exact
  double hi = fputil::multiply_add(e_x, LOG_2_HI, LOG_R_DD[index].hi);
  // lo errors ~ e_x * LSB(LOG_2_LO) + LSB(LOG_R[index].lo) + rounding err
  //           <= 2 * (e_x * LSB(LOG_2_LO) + LSB(LOG_R[index].lo))
  double lo = fputil::multiply_add(e_x, LOG_2_LO, LOG_R_DD[index].lo);

  // Set m = 1.mantissa.
  uint64_t x_m = (x_u & 0x000F'FFFF'FFFF'FFFFULL) | 0x3FF0'0000'0000'0000ULL;
  double m = FPBits_t(x_m).get_val();

  double u, u_sq, err;
  fputil::DoubleDouble r1;

  // Perform exact range reduction
#ifdef LIBC_TARGET_CPU_HAS_FMA
  u = fputil::multiply_add(r, m, -1.0); // exact
#else
  uint64_t c_m = x_m & 0x3FFF'E000'0000'0000ULL;
  double c = FPBits_t(c_m).get_val();
  u = fputil::multiply_add(r, m - c, CD[index]); // exact
#endif // LIBC_TARGET_CPU_HAS_FMA

  // Exact sum:
  //   r1.hi + r1.lo = e_x * log(2)_hi - log(r)_hi + u
  r1 = fputil::exact_add(hi, u);

  // Error of u_sq = ulp(u^2);
  u_sq = u * u;
  // Total error is bounded by ~ C * ulp(u^2).
  // Degree-7 minimax polynomial
  double p0 = fputil::multiply_add(u, LOG_COEFFS[1], LOG_COEFFS[0]);
  double p1 = fputil::multiply_add(u, LOG_COEFFS[3], LOG_COEFFS[2]);
  double p2 = fputil::multiply_add(u, LOG_COEFFS[5], LOG_COEFFS[4]);
  double p = fputil::polyeval(u_sq, lo + r1.lo, p0, p1, p2);

  // Technicallly error of r1.lo is bounded by:
  //    hi*ulp(log(2)_lo) + C*ulp(u^2)
  // To simplify the error computation a bit, we replace |hi|*ulp(log(2)_lo)
  // with the upper bound: 2^11 * ulp(log(2)_lo) = 2^-85.
  // Total error is bounded by ~ C * ulp(u^2) + 2^-85.
  err = fputil::multiply_add(u_sq, P_ERR, HI_ERR);

  // Lower bound from the result
  double left = r1.hi + (p - err);
  // Upper bound from the result
  double right = r1.hi + (p + err);

  // Ziv's test if fast pass is accurate enough.
  if (left == right)
    return left;

  return log_accurate(x_e, index, u);
}

} // namespace LIBC_NAMESPACE
