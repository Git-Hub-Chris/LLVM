// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --filter "call i32" --include-generated-funcs
// RUN: %clang_cc1 -triple aarch64-none-linux-gnu -O0 -S -emit-llvm -disable-llvm-optzns -o - %s | FileCheck %s --check-prefixes=CHECK,O0
// RUN: %clang_cc1 -triple aarch64-none-linux-gnu -O2 -S -emit-llvm -disable-llvm-optzns -o - %s | FileCheck %s --check-prefixes=CHECK,O2

// Check that we make a direct call from direct_caller._Msimd to
// direct_callee._Msimd when there is no better option.
__attribute__((target_version("simd"))) int direct_callee(void) { return 1; }
__attribute__((target_version("default"))) int direct_callee(void) { return 2; }
__attribute__((target_version("simd"))) int direct_caller(void) { return direct_callee(); }
__attribute__((target_version("default"))) int direct_caller(void) { return direct_callee(); }

__attribute__((target_version("simd"), optnone)) int optnone_caller(void) { return direct_callee(); }
__attribute__((target_version("default"), optnone)) int optnone_caller(void) { return direct_callee(); }

// ... and that we go through the ifunc+resolver when there is a better option
// that might be chosen at runtime.
__attribute__((target_version("simd"))) int resolved_callee1(void) { return 3; }
__attribute__((target_version("fcma"))) int resolved_callee1(void) { return 4; }
__attribute__((target_version("default"))) int resolved_callee1(void) { return 5; }
__attribute__((target_version("simd"))) int resolved_caller1(void) { return resolved_callee1(); }
__attribute__((target_version("default"))) int resolved_caller1(void) { return resolved_callee1(); }

// FIXME: we could direct call in cases like this:
__attribute__((target_version("fp"))) int resolved_callee2(void) { return 6; }
__attribute__((target_version("default"))) int resolved_callee2(void) { return 7; }
__attribute__((target_version("simd+fp"))) int resolved_caller2(void) { return resolved_callee2(); }
__attribute__((target_version("default"))) int resolved_caller2(void) { return resolved_callee2(); }

int source() {
    return direct_caller() + optnone_caller() + resolved_caller1() + resolved_caller2();
}

// CHECK-LABEL: @direct_callee._Msimd(
//
// CHECK-LABEL: @direct_callee.resolver(
//
//
// CHECK-LABEL: @direct_caller.resolver(
//
// CHECK-LABEL: @optnone_caller._Msimd(
// CHECK:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// CHECK-LABEL: @optnone_caller.resolver(
//
// CHECK-LABEL: @resolved_callee1._Msimd(
//
// CHECK-LABEL: @resolved_callee1.resolver(
//
// CHECK-LABEL: @resolved_caller1._Msimd(
// CHECK:    [[CALL:%.*]] = call i32 @resolved_callee1.ifunc()
//
//
// CHECK-LABEL: @resolved_caller1.resolver(
//
// CHECK-LABEL: @resolved_callee2._Mfp(
//
// CHECK-LABEL: @resolved_callee2.resolver(
//
// CHECK-LABEL: @resolved_caller2._MfpMsimd(
// CHECK:    [[CALL:%.*]] = call i32 @resolved_callee2.ifunc()
//
//
// CHECK-LABEL: @resolved_caller2.resolver(
//
// CHECK-LABEL: @source(
// CHECK:    [[CALL:%.*]] = call i32 @direct_caller.ifunc()
// CHECK:    [[CALL1:%.*]] = call i32 @optnone_caller.ifunc()
// CHECK:    [[CALL2:%.*]] = call i32 @resolved_caller1.ifunc()
// CHECK:    [[CALL4:%.*]] = call i32 @resolved_caller2.ifunc()
//
//
// CHECK-LABEL: @direct_callee.default(
//
// CHECK-LABEL: @direct_caller.default(
// CHECK:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// CHECK-LABEL: @optnone_caller.default(
// CHECK:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// CHECK-LABEL: @resolved_callee1._Mfcma(
//
// CHECK-LABEL: @resolved_callee1.default(
//
// CHECK-LABEL: @resolved_caller1.default(
// CHECK:    [[CALL:%.*]] = call i32 @resolved_callee1.ifunc()
//
//
// CHECK-LABEL: @resolved_callee2.default(
//
// CHECK-LABEL: @resolved_caller2.default(
// CHECK:    [[CALL:%.*]] = call i32 @resolved_callee2.ifunc()
//
//
// O0-LABEL: @direct_callee._Msimd(
//
// O0-LABEL: @direct_callee.resolver(
//
// O0-LABEL: @direct_caller._Msimd(
// O0:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O0-LABEL: @direct_caller.resolver(
//
// O0-LABEL: @optnone_caller._Msimd(
// O0:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O0-LABEL: @optnone_caller.resolver(
//
// O0-LABEL: @resolved_callee1._Msimd(
//
// O0-LABEL: @resolved_callee1.resolver(
//
// O0-LABEL: @resolved_caller1._Msimd(
// O0:    [[CALL:%.*]] = call i32 @resolved_callee1.ifunc()
//
//
// O0-LABEL: @resolved_caller1.resolver(
//
// O0-LABEL: @resolved_callee2._Mfp(
//
// O0-LABEL: @resolved_callee2.resolver(
//
// O0-LABEL: @resolved_caller2._MfpMsimd(
// O0:    [[CALL:%.*]] = call i32 @resolved_callee2.ifunc()
//
//
// O0-LABEL: @resolved_caller2.resolver(
//
// O0-LABEL: @source(
// O0:    [[CALL:%.*]] = call i32 @direct_caller.ifunc()
// O0:    [[CALL1:%.*]] = call i32 @optnone_caller.ifunc()
// O0:    [[CALL2:%.*]] = call i32 @resolved_caller1.ifunc()
// O0:    [[CALL4:%.*]] = call i32 @resolved_caller2.ifunc()
//
//
// O0-LABEL: @direct_callee.default(
//
// O0-LABEL: @direct_caller.default(
// O0:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O0-LABEL: @optnone_caller.default(
// O0:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O0-LABEL: @resolved_callee1._Mfcma(
//
// O0-LABEL: @resolved_callee1.default(
//
// O0-LABEL: @resolved_caller1.default(
// O0:    [[CALL:%.*]] = call i32 @resolved_callee1.ifunc()
//
//
// O0-LABEL: @resolved_callee2.default(
//
// O0-LABEL: @resolved_caller2.default(
// O0:    [[CALL:%.*]] = call i32 @resolved_callee2.ifunc()
//
//
//
// O2-LABEL: @direct_callee._Msimd(
//
// O2-LABEL: @direct_callee.resolver(
//
// O2-LABEL: @direct_caller._Msimd(
// O2:    [[CALL:%.*]] = call i32 @direct_callee._Msimd()
//
//
// O2-LABEL: @direct_caller.resolver(
//
// O2-LABEL: @optnone_caller._Msimd(
// O2:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O2-LABEL: @optnone_caller.resolver(
//
// O2-LABEL: @resolved_callee1._Msimd(
//
// O2-LABEL: @resolved_callee1.resolver(
//
// O2-LABEL: @resolved_caller1._Msimd(
// O2:    [[CALL:%.*]] = call i32 @resolved_callee1.ifunc()
//
//
// O2-LABEL: @resolved_caller1.resolver(
//
// O2-LABEL: @resolved_callee2._Mfp(
//
// O2-LABEL: @resolved_callee2.resolver(
//
// O2-LABEL: @resolved_caller2._MfpMsimd(
// O2:    [[CALL:%.*]] = call i32 @resolved_callee2.ifunc()
//
//
// O2-LABEL: @resolved_caller2.resolver(
//
// O2-LABEL: @source(
// O2:    [[CALL:%.*]] = call i32 @direct_caller.ifunc()
// O2:    [[CALL1:%.*]] = call i32 @optnone_caller.ifunc()
// O2:    [[CALL2:%.*]] = call i32 @resolved_caller1.ifunc()
// O2:    [[CALL4:%.*]] = call i32 @resolved_caller2.ifunc()
//
//
// O2-LABEL: @direct_callee.default(
//
// O2-LABEL: @direct_caller.default(
// O2:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O2-LABEL: @optnone_caller.default(
// O2:    [[CALL:%.*]] = call i32 @direct_callee.ifunc()
//
//
// O2-LABEL: @resolved_callee1._Mfcma(
//
// O2-LABEL: @resolved_callee1.default(
//
// O2-LABEL: @resolved_caller1.default(
// O2:    [[CALL:%.*]] = call i32 @resolved_callee1.ifunc()
//
//
// O2-LABEL: @resolved_callee2.default(
//
// O2-LABEL: @resolved_caller2.default(
// O2:    [[CALL:%.*]] = call i32 @resolved_callee2.ifunc()
//
