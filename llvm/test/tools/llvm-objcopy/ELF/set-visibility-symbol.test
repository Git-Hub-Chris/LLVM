
# RUN: yaml2obj %s -o %t.o

# Check if the visibility of a single symbol is set correctly,
# and none of other symbols are affected
# RUN: cp %t.o %t0.o
# RUN: llvm-objcopy %t0.o --set-symbol-visibility=default_local=hidden \
# RUN:                    --set-symbol-visibility=internal_local=protected \
# RUN:                    --set-symbol-visibility=hidden_local=internal \
# RUN:                    --set-symbol-visibility=protected_local=default
# RUN: llvm-readelf -s %t0.o | FileCheck %s --check-prefix=SINGLE

# SINGLE-DAG: HIDDEN      1 default_local
# SINGLE-DAG: PROTECTED   1 internal_local
# SINGLE-DAG: INTERNAL    1 hidden_local
# SINGLE-DAG: DEFAULT     1 protected_local
# Unaffected symbols:
# SINGLE-DAG: DEFAULT     1 default_global
# SINGLE-DAG: DEFAULT     1 default_weak
# SINGLE-DAG: INTERNAL    1 internal_global
# SINGLE-DAG: INTERNAL    1 internal_weak
# SINGLE-DAG: HIDDEN      1 hidden_global
# SINGLE-DAG: HIDDEN      1 hidden_weak
# SINGLE-DAG: PROTECTED   1 protected_global
# SINGLE-DAG: PROTECTED   1 protected_weak


# Check if the visibility of symbols specified by a regex are set correctly,
# and none of other symbols are affected
# RUN: llvm-objcopy %t.o %t1.o --set-symbol-visibility=.*_local=hidden --regex
# RUN: llvm-readelf -s %t1.o | FileCheck %s --check-prefix=REGEX

# REGEX-DAG: HIDDEN      1 default_local
# REGEX-DAG: HIDDEN      1 internal_local
# REGEX-DAG: HIDDEN      1 hidden_local
# REGEX-DAG: HIDDEN      1 protected_local
# Unaffected symbols:
# REGEX-DAG: DEFAULT     1 default_global
# REGEX-DAG: DEFAULT     1 default_weak
# REGEX-DAG: INTERNAL    1 internal_global
# REGEX-DAG: INTERNAL    1 internal_weak
# REGEX-DAG: HIDDEN      1 hidden_global
# REGEX-DAG: HIDDEN      1 hidden_weak
# REGEX-DAG: PROTECTED   1 protected_global
# REGEX-DAG: PROTECTED   1 protected_weak


!ELF
FileHeader:
  Class:           ELFCLASS64
  Data:            ELFDATA2LSB
  Type:            ET_REL
  Machine:         EM_X86_64
Sections:
  - Name:            .text
    Type:            SHT_PROGBITS
Symbols:
  - Name:    default_local
    Section: .text
    Binding:  STB_LOCAL
  - Name:    default_global
    Section: .text
    Binding:  STB_GLOBAL
  - Name:    default_weak
    Section: .text
    Binding:  STB_WEAK
  - Name:    internal_local
    Section: .text
    Binding:  STB_LOCAL
    Other:    [ STV_INTERNAL ]
  - Name:    internal_global
    Section: .text
    Binding:  STB_GLOBAL
    Other:    [ STV_INTERNAL ]
  - Name:    internal_weak
    Section: .text
    Binding:  STB_WEAK
    Other:    [ STV_INTERNAL ]
  - Name:    hidden_local
    Section: .text
    Binding:  STB_LOCAL
    Other:    [ STV_HIDDEN ]
  - Name:    hidden_global
    Section: .text
    Binding:  STB_GLOBAL
    Other:    [ STV_HIDDEN ]
  - Name:    hidden_weak
    Section: .text
    Binding:  STB_WEAK
    Other:    [ STV_HIDDEN ]
  - Name:    protected_local
    Section: .text
    Binding:  STB_LOCAL
    Other:    [ STV_PROTECTED ]
  - Name:    protected_global
    Section: .text
    Binding:  STB_GLOBAL
    Other:    [ STV_PROTECTED ]
  - Name:    protected_weak
    Section: .text
    Binding:  STB_WEAK
    Other:    [ STV_PROTECTED ]
  - Name:    ignored_name
    Section: .text
    Binding:  STB_GLOBAL
    Other:    [ STV_INTERNAL ]
