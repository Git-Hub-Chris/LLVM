; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -passes=instsimplify -S %s | FileCheck %s

define i1 @incr_sle(i32 %i, i32 %len) {
; CHECK-LABEL: define i1 @incr_sle(
; CHECK-SAME: i32 [[I:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:    ret i1 true
;
  %i.incr = add nsw nuw i32 %i, 1
  %i.lt.len = icmp samesign ugt i32 %i, %len
  %i.incr.lt.len = icmp sgt i32 %i.incr, %len
  %res = icmp sle i1 %i.incr.lt.len, %i.lt.len
  ret i1 %res
}

define i1 @incr_sge(i32 %i, i32 %len) {
; CHECK-LABEL: define i1 @incr_sge(
; CHECK-SAME: i32 [[I:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:    ret i1 true
;
  %i.incr = add nsw nuw i32 %i, 1
  %i.lt.len = icmp samesign ult i32 %i, %len
  %i.incr.lt.len = icmp slt i32 %i.incr, %len
  %res = icmp sge i1 %i.incr.lt.len, %i.lt.len
  ret i1 %res
}

define i1 @incr_ule(i32 %i, i32 %len) {
; CHECK-LABEL: define i1 @incr_ule(
; CHECK-SAME: i32 [[I:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:    ret i1 true
;
  %i.incr = add nsw nuw i32 %i, 1
  %i.lt.len = icmp samesign ugt i32 %i, %len
  %i.incr.lt.len = icmp sgt i32 %i.incr, %len
  %res = icmp ule i1 %i.lt.len, %i.incr.lt.len
  ret i1 %res
}

define i1 @incr_uge(i32 %i, i32 %len) {
; CHECK-LABEL: define i1 @incr_uge(
; CHECK-SAME: i32 [[I:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:    ret i1 true
;
  %i.incr = add nsw nuw i32 %i, 1
  %i.lt.len = icmp samesign ult i32 %i, %len
  %i.incr.lt.len = icmp slt i32 %i.incr, %len
  %res = icmp uge i1 %i.lt.len, %i.incr.lt.len
  ret i1 %res
}

define i1 @sgt_implies_ge_via_assume(i32 %i, i32 %j) {
; CHECK-LABEL: define i1 @sgt_implies_ge_via_assume(
; CHECK-SAME: i32 [[I:%.*]], i32 [[J:%.*]]) {
; CHECK-NEXT:    [[I_GT_J:%.*]] = icmp sgt i32 [[I]], [[J]]
; CHECK-NEXT:    call void @llvm.assume(i1 [[I_GT_J]])
; CHECK-NEXT:    ret i1 true
;
  %i.gt.j = icmp sgt i32 %i, %j
  call void @llvm.assume(i1 %i.gt.j)
  %i.ge.j = icmp samesign uge i32 %i, %j
  ret i1 %i.ge.j
}

define i32 @gt_implies_sge_dominating(i32 %a, i32 %len) {
; CHECK-LABEL: define i32 @gt_implies_sge_dominating(
; CHECK-SAME: i32 [[A:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*]]:
; CHECK-NEXT:    [[A_GT_LEN:%.*]] = icmp samesign ugt i32 [[A]], [[LEN]]
; CHECK-NEXT:    br i1 [[A_GT_LEN]], label %[[TAKEN:.*]], label %[[END:.*]]
; CHECK:       [[TAKEN]]:
; CHECK-NEXT:    br label %[[END]]
; CHECK:       [[END]]:
; CHECK-NEXT:    [[RES:%.*]] = phi i32 [ -1, %[[ENTRY]] ], [ 30, %[[TAKEN]] ]
; CHECK-NEXT:    ret i32 [[RES]]
;
entry:
  %a.gt.len = icmp samesign ugt i32 %a, %len
  br i1 %a.gt.len, label %taken, label %end

taken:
  %a.sge.len = icmp sge i32 %a, %len
  %c = select i1 %a.sge.len, i32 30, i32 0
  br label %end

end:
  %res = phi i32 [-1, %entry], [%c, %taken]
  ret i32 %res
}

define i32 @gt_implies_sge_dominating_cr(i32 %a, i32 %len) {
; CHECK-LABEL: define i32 @gt_implies_sge_dominating_cr(
; CHECK-SAME: i32 [[A:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*]]:
; CHECK-NEXT:    [[A_GT_20:%.*]] = icmp samesign ugt i32 [[A]], 20
; CHECK-NEXT:    br i1 [[A_GT_20]], label %[[TAKEN:.*]], label %[[END:.*]]
; CHECK:       [[TAKEN]]:
; CHECK-NEXT:    br label %[[END]]
; CHECK:       [[END]]:
; CHECK-NEXT:    [[RES:%.*]] = phi i32 [ -1, %[[ENTRY]] ], [ 30, %[[TAKEN]] ]
; CHECK-NEXT:    ret i32 [[RES]]
;
entry:
  %a.gt.20 = icmp samesign ugt i32 %a, 20
  br i1 %a.gt.20, label %taken, label %end

taken:
  %a.sge.minus.10 = icmp sge i32 %a, 10
  %c = select i1 %a.sge.minus.10, i32 30, i32 0
  br label %end

end:
  %res = phi i32 [-1, %entry], [%c, %taken]
  ret i32 %res
}

define i32 @sgt_implies_ge_dominating_cr(i32 %a, i32 %len) {
; CHECK-LABEL: define i32 @sgt_implies_ge_dominating_cr(
; CHECK-SAME: i32 [[A:%.*]], i32 [[LEN:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*]]:
; CHECK-NEXT:    [[A_SGT_20:%.*]] = icmp sgt i32 [[A]], -10
; CHECK-NEXT:    br i1 [[A_SGT_20]], label %[[TAKEN:.*]], label %[[END:.*]]
; CHECK:       [[TAKEN]]:
; CHECK-NEXT:    br label %[[END]]
; CHECK:       [[END]]:
; CHECK-NEXT:    [[RES:%.*]] = phi i32 [ -1, %[[ENTRY]] ], [ 30, %[[TAKEN]] ]
; CHECK-NEXT:    ret i32 [[RES]]
;
entry:
  %a.sgt.20 = icmp sgt i32 %a, -10
  br i1 %a.sgt.20, label %taken, label %end

taken:
  %a.ge.10 = icmp samesign uge i32 %a, -20
  %c = select i1 %a.ge.10, i32 30, i32 0
  br label %end

end:
  %res = phi i32 [-1, %entry], [%c, %taken]
  ret i32 %res
}

define i32 @gt_sub_nsw(i32 %x, i32 %y) {
; CHECK-LABEL: define i32 @gt_sub_nsw(
; CHECK-SAME: i32 [[X:%.*]], i32 [[Y:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    [[CMP:%.*]] = icmp samesign ugt i32 [[X]], [[Y]]
; CHECK-NEXT:    br i1 [[CMP]], label %[[COND_TRUE:.*]], label %[[COND_END:.*]]
; CHECK:       [[COND_TRUE]]:
; CHECK-NEXT:    [[SUB:%.*]] = sub nsw i32 [[X]], [[Y]]
; CHECK-NEXT:    [[ADD:%.*]] = add nsw i32 [[SUB]], 1
; CHECK-NEXT:    ret i32 [[ADD]]
; CHECK:       [[COND_END]]:
; CHECK-NEXT:    ret i32 0
;
entry:
  %cmp = icmp samesign ugt i32 %x, %y
  br i1 %cmp, label %cond.true, label %cond.end

cond.true:
  %sub = sub nsw i32 %x, %y
  %add = add nsw i32 %sub, 1
  %neg = xor i32 %sub, -1
  %abscond = icmp samesign ult i32 %sub, -1
  %abs = select i1 %abscond, i32 %neg, i32 %add
  ret i32 %abs

cond.end:
  ret i32 0
}

define i32 @ge_sub_nsw(i32 %x, i32 %y) {
; CHECK-LABEL: define i32 @ge_sub_nsw(
; CHECK-SAME: i32 [[X:%.*]], i32 [[Y:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    [[CMP:%.*]] = icmp samesign uge i32 [[X]], [[Y]]
; CHECK-NEXT:    br i1 [[CMP]], label %[[COND_TRUE:.*]], label %[[COND_END:.*]]
; CHECK:       [[COND_TRUE]]:
; CHECK-NEXT:    [[SUB:%.*]] = sub nsw i32 [[X]], [[Y]]
; CHECK-NEXT:    [[ADD:%.*]] = add nsw i32 [[SUB]], 1
; CHECK-NEXT:    ret i32 [[ADD]]
; CHECK:       [[COND_END]]:
; CHECK-NEXT:    ret i32 0
;
entry:
  %cmp = icmp samesign uge i32 %x, %y
  br i1 %cmp, label %cond.true, label %cond.end

cond.true:
  %sub = sub nsw i32 %x, %y
  %add = add nsw i32 %sub, 1
  %neg = xor i32 %sub, -1
  %abscond = icmp samesign ult i32 %sub, -1
  %abs = select i1 %abscond, i32 %neg, i32 %add
  ret i32 %abs

cond.end:
  ret i32 0
}
