; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 4
; RUN: opt < %s -passes=div-rem-pairs -S -mtriple=amdgcn-amd-amdhsa | FileCheck %s

define i32 @basic(ptr %p, i32 %x, i32 %y) {
; CHECK-LABEL: define i32 @basic(
; CHECK-SAME: ptr [[P:%.*]], i32 [[X:%.*]], i32 [[Y:%.*]]) {
; CHECK-NEXT:    [[X_FROZEN:%.*]] = freeze i32 [[X]]
; CHECK-NEXT:    [[Y_FROZEN:%.*]] = freeze i32 [[Y]]
; CHECK-NEXT:    [[DIV:%.*]] = udiv i32 [[X_FROZEN]], [[Y_FROZEN]]
; CHECK-NEXT:    [[TMP1:%.*]] = mul i32 [[DIV]], [[Y_FROZEN]]
; CHECK-NEXT:    [[REM_DECOMPOSED:%.*]] = sub i32 [[X_FROZEN]], [[TMP1]]
; CHECK-NEXT:    store i32 [[DIV]], ptr [[P]], align 4
; CHECK-NEXT:    ret i32 [[REM_DECOMPOSED]]
;
  %div = udiv i32 %x, %y
  %rem = urem i32 %x, %y
  store i32 %div, ptr %p, align 4
  ret i32 %rem
}

define i32 @no_freezes(ptr %p, i32 noundef %x, i32 noundef %y) {
; CHECK-LABEL: define i32 @no_freezes(
; CHECK-SAME: ptr [[P:%.*]], i32 noundef [[X:%.*]], i32 noundef [[Y:%.*]]) {
; CHECK-NEXT:    [[DIV:%.*]] = udiv i32 [[X]], [[Y]]
; CHECK-NEXT:    [[TMP1:%.*]] = mul i32 [[DIV]], [[Y]]
; CHECK-NEXT:    [[REM_DECOMPOSED:%.*]] = sub i32 [[X]], [[TMP1]]
; CHECK-NEXT:    store i32 [[DIV]], ptr [[P]], align 4
; CHECK-NEXT:    ret i32 [[REM_DECOMPOSED]]
;
  %div = udiv i32 %x, %y
  %rem = urem i32 %x, %y
  store i32 %div, ptr %p, align 4
  ret i32 %rem
}

; FIXME: There should be no need to `freeze` x2 and y2 since they have defined
; but potentially poison values.
define i32 @poison_does_not_freeze(ptr %p, i32 noundef %x, i32 noundef %y) {
; CHECK-LABEL: define i32 @poison_does_not_freeze(
; CHECK-SAME: ptr [[P:%.*]], i32 noundef [[X:%.*]], i32 noundef [[Y:%.*]]) {
; CHECK-NEXT:    [[X2:%.*]] = shl nuw nsw i32 [[X]], 5
; CHECK-NEXT:    [[Y2:%.*]] = add nuw nsw i32 [[Y]], 1
; CHECK-NEXT:    [[X2_FROZEN:%.*]] = freeze i32 [[X2]]
; CHECK-NEXT:    [[Y2_FROZEN:%.*]] = freeze i32 [[Y2]]
; CHECK-NEXT:    [[DIV:%.*]] = udiv i32 [[X2_FROZEN]], [[Y2_FROZEN]]
; CHECK-NEXT:    [[TMP1:%.*]] = mul i32 [[DIV]], [[Y2_FROZEN]]
; CHECK-NEXT:    [[REM_DECOMPOSED:%.*]] = sub i32 [[X2_FROZEN]], [[TMP1]]
; CHECK-NEXT:    store i32 [[DIV]], ptr [[P]], align 4
; CHECK-NEXT:    ret i32 [[REM_DECOMPOSED]]
;
  %x2 = shl nuw nsw i32 %x, 5
  %y2 = add nuw nsw i32 %y, 1
  %div = udiv i32 %x2, %y2
  %rem = urem i32 %x2, %y2
  store i32 %div, ptr %p, align 4
  ret i32 %rem
}
